---
navigation_title: AWS
description: Set up the EDOT Cloud Forwarder for AWS to bring your AWS logs to Elastic Observability.
applies_to:
  serverless:
    observability: preview
#  deployment:
#    ess: preview
  product:
    edot_cf_aws: preview
products:
  - id: cloud-serverless
  - id: observability
  - id: edot-cf
---

# EDOT Cloud Forwarder for AWS

{{edot-cf}} (CF) for AWS provides the EDOT Collector as a Lambda function that collects and forwards logs to Elastic Observability on {{serverless-full}}. 

{{edot-cf}} for AWS supports the following log sources:

| AWS Service | Telemetry Description |
| --- | --- |
| Virtual Private Cloud (VPC) | [VPC Flow Logs](https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html) to capture information about IP traffic  |
| Elastic Load Balancer (ELB) | [Access logs](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html) for your Application Load Balancer |
| AWS CloudTrail | [CloudTrail Logs](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-log-file-examples.html) to record account activity |
% | CloudWatch {applies_to}`product: planned` | Logs generated by AWS CloudWatch |

Read on to learn how to set up {{edot-cf}} for AWS.

::::{note}
We are working to support other popular log types and sources. Get in touch to let us know of any specific requirements that could influence our plans.
::::

## Prerequisites

::::{important}
{{edot-cf}} for AWS requires a Managed OTLP endpoint and an API key. Managed OTLP is available for {{serverless-full}} and will soon be available for {{ech}}.

For self-managed deployments, set up an EDOT Collector in [Gateway mode](elastic-agent://reference/edot-collector/config/default-config-standalone.md#gateway-mode) that ingests OTel data from the edge setup into the self-managed Elastic Stack.
::::


To collect logs using {{edot-cf}} for AWS, you need:

::::{tab-set}

:::{tab-item} VPC Flow

To collect VPC Flow logs, you need:

- A Virtual Private Cloud (VPC)
- An S3 bucket for storing flow logs
- A flow log configured with the S3 bucket as the destination

:::

:::{tab-item} ELB Access

To collect Elastic Load Balancer (ELB) Access logs, you need:

- An ELB of any type (ALB, NLB, CLB)
- An S3 bucket to store the access logs
- Access logging enabled, with the bucket as the destination

:::

:::{tab-item} CloudTrail

To collect AWS CloudTrail logs, you need:

- A trail that delivers account events as log files to an Amazon S3 bucket
- An S3 bucket to store the trail logs

:::

<!--
:::{tab-item} CloudWatch

To collect CloudWatch logs, you need:

- A CloudWatch Log Group where logs are stored

:::
-->
::::

In addition, you need to know the URL of the managed OTLP endpoint and the API key for authentication.

::::{dropdown} Steps to retrieve the OTLP endpoint and API key

:::{include} ../_snippets/serverless-endpoint-api.md
:::

In the CloudFormation templates, the OTLP endpoint is set as `OTLPEndpoint`, and the API key is set as `ElasticAPIKey`. 

:::{important}
Trim the API key from `Authorization=ApiKey MYKEYVALUE...` to just `MYKEYVALUE...` before using it as the argument to the `ElasticAPIKey` parameter.
:::
::::

## Deployment options

{{edot-cf}} for AWS can be deployed using any of the following methods:

| Deployment Method | Description |
| --- | --- |
| **CloudFormation (AWS CLI)** | Deploy using AWS CLI commands with CloudFormation templates. |
| **CloudFormation (AWS Console)** | Deploy using the AWS Management Console UI. |
<!-- Not Public yet
| **AWS Serverless Application Repository (SAR)** | Deploy directly from the AWS Serverless Application Repository. |
-->

Each method achieves the same result and uses CloudFormation templates under the hood. Choose the method that best fits your workflow.

## Deployment considerations

Before deploying {{edot-cf}} for AWS, keep these points in mind:

- Deploy a separate CloudFormation stack for each log type, for example VPC Flow Logs or ELB Access Logs. Each CloudFormation stack can only process one log type and format at a time.
- Logs stored in S3 must be placed in separate buckets. Each log type should reside in its own dedicated bucket.
- The CloudFormation stack deployment region must match the region of the S3 bucket.

## CloudFormation templates

The CloudFormation templates are hosted in a public Amazon S3 bucket and can be accessed via HTTPS URL. You can reference these templates directly during deployment or download them for local use.

| Log Source | CloudFormation template |
| --- | ------------------------------------------------ |
| S3 logs | `https://edot-cloud-forwarder.s3.amazonaws.com/v0/latest/cloudformation/s3_logs-cloudformation.yaml` |
% | CloudWatch logs | `https://edot-cloud-forwarder.s3.amazonaws.com/v0/latest/cloudformation/cloudwatch_logs-cloudformation.yaml` |

For specific versions, edit `latest` in the URL to the required version in the format `vX.Y.Z`.

## Configure the template

Before deploying {{edot-cf}} for AWS, configure the CloudFormation template parameters based on your specific requirements. The template uses settings below to deploy and configure the EDOT Collector Lambda function.

### Required settings

These are the required settings you need:

| Setting                                | Description |
| -------------------------------------- | ----------- |
| `stack-name`                           | Name of the CloudFormation stack, for example, `vpc-edot-cf`<br>Do not use the same name for different stacks. |
| `OTLPEndpoint`                         | The OTLP endpoint URL used for data ingestion, obtained from {{serverless-full}}. |
| `ElasticApiKey`                        | API key for authentication with Elastic, obtained from {{serverless-full}}. |

### Log source settings

Set the following settings based on the log source:

:::::{tab-set}

::::{tab-item} S3

For S3 logs, use the following settings:

| Setting            | Description |
| ------------------ | --- |
| `EdotCloudForwarderS3LogsType` | The encoding format for logs in the S3 bucket. Supported options:<br>- `vpcflow`: VPC Flow Logs<br>- `elbaccess`: ELB Access logs<br>- `cloudtrail`: CloudTrail Logs|
| `SourceS3BucketARN` | Amazon Resource Name (ARN) of the S3 bucket where logs are stored. This bucket will trigger the `edot-cloud-forwarder` Lambda function automatically. |
% | `S3LogsJsonEncodingMode` | _(Required if `EdotCloudForwarderS3LogsType` is `json`)_<br>Defines how JSON logs are structured:<br>- `body` _(default)_: Stores logs in the request body<br>- `body_with_inline_attributes`: Logs include inline attributes |

::::

<!-- TODO: Enable when CloudWatch logs are supported
::::{tab-item} CloudWatch

For CloudWatch logs, use the following settings:

| Setting            | Description |
| ------------------- | --- |
| `SourceCloudWatchLogGroupARN` | Amazon Resource Name (ARN) of the CloudWatch Log Group where the subscription filter will be created. This Log Group serves as the primary storage location for logs. |

:::{note}
The log group must already exist in your AWS account and region. If the ARN points to a non-existent log group, stack deployment or updates might fail.
:::
::::

-->

:::::

### Optional settings

These are optional settings you can set in the CloudFormation template:

| Setting            | Description                                                                                                                                                                                                  |
| ------------------- |--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `EdotCloudForwarderTimeout` | Maximum execution time for the Lambda function, measured in seconds. Default value is `300` seconds (5 minutes). Minimum value is `1` second. Maximum value is `900` seconds. **When to increase**: If you experience Lambda timeouts when processing large log files. Most files process in 1-3 seconds, but larger files may need more time.                                            |
| `EdotCloudForwarderVersion` | Version of the EDOT Cloud Forwarder. Expected format is semantic versioning, for example `0.2.4`. Defaults to the latest available patch version. Don't change this value unless advised by Elastic Support. |
| `EdotCloudForwarderMemorySize` | Set the allocated memory for the Lambda function, measured in megabytes. Default value is `512` MB. Minimum value is `128` MB. Maximum value is `10240` MB. **When to increase**: If memory usage consistently exceeds 80% or if you observe Lambda timeouts and processing times increase significantly. More memory also increases CPU, which improves processing speed and reduces timeouts.                                                  | 
| `EdotCloudForwarderConcurrentExecutions` | Set the maximum number of reserved concurrent executions for the Lambda function. Default value is `5`. **When to increase**: If new log files arrive frequently and you observe Lambda processing times consistently exceeding 1-2 seconds, consider increasing concurrent executions. Concurrent Lambda invocations are only spawned when needed (when new files arrive). This allows multiple log files to be processed in parallel instead of sequentially, avoiding processing delays. Make sure this value doesn't exceed your AWS account's concurrency limit.                            |
| `EdotCloudForwarderExporterMaxQueueSize` | Set the internal OTLP exporter queue size, measured in bytes. Default is `50000000` (50 MB). **When to increase**: If you see "element size too large" errors in your Lambda CloudWatch logs, indicating the queue is full and data is being dropped. This prevents data loss during export.                                                                                                |

The default values provided have been determined through extensive load testing across different log types and data volumes. For most use cases, these defaults provide a good balance between cost and performance. Adjust these parameters only if you observe performance issues such as Lambda timeouts, throttling, high memory usage or data being dropped. If you need assistance tuning these parameters for your specific workload, contact Elastic Support.

## Deploy using CloudFormation (AWS CLI)

Use the AWS CLI to deploy the EDOT Cloud Forwarder with CloudFormation templates. This method is ideal for automation and infrastructure-as-code workflows.

### Deployment examples

The following examples show how to deploy the ECF Cloud Forwarder using AWS CloudFormation CLI. Copy and paste these commands after replacing the placeholder values with your actual configuration.

- Use the `--template-url` flag to reference a template hosted on S3. 
- Use the `--region` flag to specify the AWS region where the CloudFormation stack will be deployed. The CloudFormation stack deployment region must match the region of the S3 bucket where your logs are stored.
- To always use the most recent stable templates, use the `latest` path. For example, `v0/latest`.  
- To pin a specific version, replace `latest` with the desired version tag. For example, `v0/v{{version.edot-cf-aws}}`.  

Alternatively, if you have downloaded the template file, use the `--template-body file://<path>` option with a local template file.

:::::{tab-set}
::::{tab-item} VPC Flow logs

This example deploys a CloudFormation stack to collect VPC Flow logs stored in an S3 bucket.

```sh
aws cloudformation create-stack \
  --stack-name edot-cloud-forwarder-vpc \
  --template-url https://edot-cloud-forwarder.s3.amazonaws.com/v0/latest/cloudformation/s3_logs-cloudformation.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameters \
    ParameterKey=SourceS3BucketARN,ParameterValue=your-s3-vpc-bucket-arn \
    ParameterKey=OTLPEndpoint,ParameterValue="<placeholder>" \
    ParameterKey=ElasticAPIKey,ParameterValue="<placeholder>" \
    ParameterKey=EdotCloudForwarderS3LogsType,ParameterValue="vpcflow"
```
::::

::::{tab-item} ELB Access logs

This example deploys a CloudFormation stack to collect ALB Access logs stored in an S3 bucket.

```sh
aws cloudformation create-stack \
  --stack-name edot-cloud-forwarder-alb \
  --template-url https://edot-cloud-forwarder.s3.amazonaws.com/v0/latest/cloudformation/s3_logs-cloudformation.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameters \
    ParameterKey=SourceS3BucketARN,ParameterValue=your-s3-alb-bucket-arn \
    ParameterKey=OTLPEndpoint,ParameterValue="<placeholder>" \
    ParameterKey=ElasticAPIKey,ParameterValue="<placeholder>" \
    ParameterKey=EdotCloudForwarderS3LogsType,ParameterValue="elbaccess"
```
::::

::::{tab-item} CloudTrail logs

This example deploys a CloudFormation stack to collect CloudTrail logs stored in an S3 bucket.

```sh
aws cloudformation create-stack \
  --stack-name edot-cloud-forwarder-cloudtrail \
  --template-url https://edot-cloud-forwarder.s3.amazonaws.com/v0/latest/cloudformation/s3_logs-cloudformation.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameters \
    ParameterKey=SourceS3BucketARN,ParameterValue=your-cloudtrail-bucket-arn \
    ParameterKey=OTLPEndpoint,ParameterValue="<placeholder>" \
    ParameterKey=ElasticAPIKey,ParameterValue="<placeholder>" \
    ParameterKey=EdotCloudForwarderS3LogsType,ParameterValue="cloudtrail_log"
```
::::

<!-- To be added post GA

::::{tab-item} S3 Access logs

This example deploys a CloudFormation stack to collect S3 Access logs stored in an S3 bucket.

```sh
aws cloudformation create-stack \
  --stack-name edot-cloud-forwarder-s3-access \
  --template-url https://edot-cloud-forwarder.s3.amazonaws.com/v0/latest/cloudformation/s3_logs-cloudformation.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameters \
    ParameterKey=SourceS3BucketARN,ParameterValue=your-s3-access-logs-bucket-arn \
    ParameterKey=OTLPEndpoint,ParameterValue="<placeholder>" \
    ParameterKey=ElasticAPIKey,ParameterValue="<placeholder>" \
    ParameterKey=EdotCloudForwarderS3LogsType,ParameterValue="s3_access_log"
```
::::

::::{tab-item} WAF logs

This example deploys a CloudFormation stack to collect AWS WAF logs stored in an S3 bucket.

```sh
aws cloudformation create-stack \
  --stack-name edot-cloud-forwarder-waf \
  --template-url https://edot-cloud-forwarder.s3.amazonaws.com/v0/latest/cloudformation/s3_logs-cloudformation.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameters \
    ParameterKey=SourceS3BucketARN,ParameterValue=arn:aws:s3:::aws-waf-logs-your-bucket-arn \
    ParameterKey=OTLPEndpoint,ParameterValue="<placeholder>" \
    ParameterKey=ElasticAPIKey,ParameterValue="<placeholder>" \
    ParameterKey=EdotCloudForwarderS3LogsType,ParameterValue="waf_log"
```

:::{note}
Replace `aws-waf-logs-your-bucket-name` with your actual WAF logging bucket ARN. Remember that the bucket name must start with `aws-waf-logs-` as required by AWS WAF.
:::
::::

::::{tab-item} JSON logs

This example deploys a CloudFormation stack to collect JSON-formatted logs stored in an S3 bucket.

```sh
aws cloudformation create-stack \
  --stack-name edot-cloud-forwarder-json \
  --template-url https://edot-cloud-forwarder.s3.amazonaws.com/v0/latest/cloudformation/s3_logs-cloudformation.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameters \
    ParameterKey=SourceS3BucketARN,ParameterValue=your-json-logs-bucket-arn \
    ParameterKey=OTLPEndpoint,ParameterValue="<placeholder>" \
    ParameterKey=ElasticAPIKey,ParameterValue="<placeholder>" \
    ParameterKey=EdotCloudForwarderS3LogsType,ParameterValue="json" \
    ParameterKey=S3LogsJsonEncodingMode,ParameterValue="body"
```
::::

::::{tab-item} CloudWatch logs

This example deploys a CloudFormation stack to collect CloudWatch logs sent to a Log Group.

```sh
aws cloudformation create-stack \
  --stack-name edot-cloud-forwarder-cw \
  --template-url https://edot-cloud-forwarder.s3.amazonaws.com/v0/latest/cloudformation/cloudwatch_logs-cloudformation.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameters \
    ParameterKey=OTLPEndpoint,ParameterValue="<placeholder>" \
    ParameterKey=ElasticAPIKey,ParameterValue="<placeholder>" \
    ParameterKey=SourceCloudWatchLogGroupARN,ParameterValue="<your-log-group-arn>"
```

-->

:::{note}
The `--capabilities CAPABILITY_NAMED_IAM` flag is required because this CloudFormation template creates AWS Identity and Access Management (IAM) resources. More specifically, it creates a named IAM role (`LambdaExecutionRole`) for the Lambda function. To acknowledge that AWS CloudFormation might create or modify IAM resources with custom names, you must specify the `CAPABILITY_NAMED_IAM` capability. 
:::

::::
:::::

### Update an existing stack

To update an existing CloudFormation stack while preserving some parameter values, follow these steps:

::::::{stepper}

:::::{step} Identify the stack to update

Determine the name of the CloudFormation stack you want to modify.

:::::

:::::{step} Prepare the update command

Use the following structure for your update command:

- Include all required parameters.
- Use `UsePreviousValue=true` for parameters that should remain unchanged.
- Specify `ParameterValue=<new-value>` for parameters that need to be updated.

:::::

:::::{step} Run the `update-stack` command

Run the command with the following parameters:

```sh
aws cloudformation update-stack \
  --template-url https://edot-cloud-forwarder.s3.amazonaws.com/v0/latest/cloudformation/<template-file-name>.yaml \
  --stack-name <stack-name> \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameters \
      ParameterKey=Param1,UsePreviousValue=true \
      ParameterKey=Param2,UsePreviousValue=true \
      ParameterKey=Param3,UsePreviousValue=true \
      ParameterKey=Param4,ParameterValue=<new-value>
```
::::{dropdown} Example using S3 logs template
For example, to modify the S3 bucket ARN for the `edot-cloud-forwarder-vpc` stack while keeping other parameter values unchanged:

```sh
aws cloudformation update-stack \
  --template-url https://edot-cloud-forwarder.s3.amazonaws.com/v0/latest/cloudformation/s3_logs-cloudformation.yaml \
  --stack-name edot-cloud-forwarder-vpc \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameters \
      ParameterKey=OTLPEndpoint,UsePreviousValue=true \
      ParameterKey=ElasticAPIKey,UsePreviousValue=true \
      ParameterKey=EdotCloudForwarderS3LogsType,UsePreviousValue=true \
      ParameterKey=SourceS3BucketARN,ParameterValue=your-new-s3-vpc-bucket-arn
```
::::
:::::

:::::{step} Verify the update

After running the command, check the stack status in the AWS Management Console under **CloudFormation** → **Stacks**. Then, run this command to confirm the updated parameter values:

```sh
aws cloudformation describe-stacks --stack-name <stack-name>
```
:::::
::::::

## Deploy using CloudFormation (AWS Console)

### Quick deployment (direct link)

For fastest deployment, use the direct link to launch the CloudFormation console with the S3 logs template pre-loaded:

1. Click the link below to open the AWS CloudFormation console with the template automatically loaded:
   - [Launch Stack (S3 logs)](https://console.aws.amazon.com/cloudformation/home?#/stacks/new?templateURL=https://edot-cloud-forwarder.s3.amazonaws.com/v0/latest/cloudformation/s3_logs-cloudformation.yaml)

2. The stack creation wizard will open. Configure all required parameters using the settings described in [Configure the template](#configure-the-template).  
3. Select **Next** and check **Acknowledge IAM capabilities**. This is required because the template creates named IAM roles with permissions to access the required resources.  
4. Review your configuration and select **Submit** to deploy the stack.  
5. Monitor the progress until the stack reaches the `CREATE_COMPLETE` state.

### Manual deployment

If you prefer to manually specify the template, follow these steps:

1. Navigate to **CloudFormation** in the AWS Console. 
2. Select **Create Stack** and choose **With new resources (standard)** to start a fresh deployment.
3. Select one of the following options under **Specify template**:  
   - **Amazon S3 URL (Recommended)**: Paste the CloudFormation template URL from [CloudFormation templates](#cloudformation-templates).
   - **Upload a template file**: Download the template from the S3 URL and upload it manually.
4. Select **Next** and configure all required parameters using the settings described in [Configure the template](#configure-the-template).  
5. Select **Next** again and check **Acknowledge IAM capabilities**. This is required because the template creates named IAM roles with permissions to access the required resources.  
6. Review your configuration and select **Submit** to deploy the stack.  
7. Monitor the progress until the stack reaches the `CREATE_COMPLETE` state.


### Update an existing stack

To modify parameters of an existing stack through the AWS Console:

1. Navigate to **CloudFormation** in the AWS Management Console.  
2. Select the stack you want to update.  
3. Click **Update stack** and select either **Make a direct update** or **Create a change set**.
4. Choose **Use existing template**.  
4. Select **Next**.  
5. Modify the parameter values as needed (refer to [Configure the template](#configure-the-template) for parameter descriptions).  
6. Select **Next** and review your changes.  
7. Select **Submit** to apply the updates. In case of a change set, **Execute changeset** .
8. Monitor the stack update progress in the console.

<!-- Not public yet
## Deploy using AWS Serverless Application Repository

In addition to deploying via CloudFormation templates, you can deploy the EDOT Cloud Forwarder application directly from the AWS Serverless Application Repository (SAR).

### Deploy from SAR

To deploy from SAR, follow these steps:

1. Navigate to **AWS Serverless Application Repository** in the AWS Management Console.
2. Search for `edot-cloud-forwarder-s3-logs` and select the application.
3. Select **Deploy**.
4. **Configure the application settings**: You will be prompted to fill in the same parameters described in the [Configure the template](#configure-the-template) section. Refer to that section for details on each parameter.
5. **Acknowledge IAM role creation**: At the bottom of the page, check the box to acknowledge that the application will create custom IAM roles. This is required for the forwarder to access your S3 bucket and send data to Elastic Observability.
6. Select **Deploy**.

The deployment process will start, and a CloudFormation stack will be created with all the necessary resources. You can monitor the progress in the AWS CloudFormation console under **Stacks**.

:::{note}
The same [deployment considerations](#deployment-considerations) apply to SAR deployments, including the requirement to deploy separate serverless applications for each log type and ensure the deployment region matches your S3 bucket region.
:::
-->

## CloudFormation stack resources

The CloudFormation templates create a number of resources to process logs from a specific log source.

### Resources for S3 logs

This is a list of resources created by the stack when processing S3 logs.

| Resource name               | Type                             | Description |
|---------------------------|--------------------------------------|----------------|
| `CustomNotificationUpdater` | `AWS::CloudFormation::CustomResource` | Custom resource used to manage S3 event notifications dynamically. |
| `LambdaExecutionRole`       | `AWS::IAM::Role`                   | IAM role granting permissions needed for the Lambda function to interact with S3 and other AWS services. |
| `LambdaFunction`            | `AWS::Lambda::Function`            | Core Lambda function responsible for processing incoming logs from S3. This is a key resource in the stack. |
| `LambdaInvokeConfig`        | `AWS::Lambda::EventInvokeConfig`   | Configures error handling and invocation settings for the Lambda function. |
| `LambdaLogGroup`            | `AWS::Logs::LogGroup`               | CloudWatch log group storing logs for the main Lambda function. Useful for debugging and monitoring. |
| `LambdaPermissionS3Bucket`  | `AWS::Lambda::Permission`          | Grants permission for S3 to invoke the Lambda function when new logs arrive. |
| `LambdaS3TriggerPolicy`     | `AWS::IAM::Policy`                 | IAM policy allowing the Lambda function to process events triggered by S3. |
| `NotificationUpdaterLambda` | `AWS::Lambda::Function`            | Utility Lambda function handling S3 event notification updates dynamically. |
| `NotificationUpdaterLambdaLogGroup` | `AWS::Logs::LogGroup`         | CloudWatch log group storing logs for the `NotificationUpdaterLambda` function. |
| `S3FailureBucketARN`               | `AWS::S3::Bucket`                   | ARN of the bucket for storing failed invocations from the `edot-cloud-forwarder` Lambda function, preventing data loss, in the format `arn:aws:s3:::your-bucket-name`. If not defined, the template creates a dedicated failure bucket automatically. |

The main Lambda function, `LambdaFunction`, is the core component for processing S3 logs. S3 event notifications are handled dynamically using `CustomNotificationUpdater` and `NotificationUpdaterLambda`. 

CloudWatch logs ensure detailed monitoring of Lambda executions. IAM roles and permissions control access between S3 and Lambda functions, while `S3FailureBucketARN` prevents data loss by capturing unprocessed logs.


<!-- TODO: Enable when CloudWatch logs are supported

### Resources for CloudWatch Logs

This is a list of resources created by the stack when CloudWatch logs are the source.

| Resource name                  | Type                             | Description |
|------------------------------------|--------------------------------------|----------------|
| `CloudWatchLogSubscriptionFilter` | `AWS::Logs::SubscriptionFilter` | Defines a filter that forwards logs from a CloudWatch Log Group to the Lambda function. Critical for log processing. |
| `LambdaExecutionRole`              | `AWS::IAM::Role`                   | IAM role granting necessary permissions for the Lambda function to interact with CloudWatch Logs and other AWS services. |
| `LambdaFunction`                   | `AWS::Lambda::Function`            | Core Lambda function responsible for processing incoming logs from CloudWatch. This is a key resource in the stack. |
| `LambdaInvokeConfig`               | `AWS::Lambda::EventInvokeConfig`   | Configures event invocation settings, including error handling and retry behavior. |
| `LambdaLogGroup`                   | `AWS::Logs::LogGroup`               | CloudWatch log group that stores execution logs for the main Lambda function, aiding monitoring and debugging. |
| `LambdaPermissionCloudWatch`       | `AWS::Lambda::Permission`          | Grants permission for CloudWatch Logs to invoke the Lambda function, enabling real-time log streaming. |
| `S3FailureBucketARN`               | `AWS::S3::Bucket`                   | ARN of the bucket for storing failed log events to prevent data loss, in the format `arn:aws:s3:::your-bucket-name`. |

The CloudWatch Log Subscription Filter, `CloudWatchLogSubscriptionFilter`, ensures logs are correctly forwarded to the Lambda function. The Lambda function, `LambdaFunction`, serves as the core processing unit for CloudWatch logs. 

CloudWatch Log Groups help monitor execution performance and debug issues. IAM permissions (`LambdaExecutionRole`, `LambdaPermissionCloudWatch`) control interactions between CloudWatch and Lambda, while the failure bucket, `S3FailureBucketARN`, helps prevent data loss in case of processing errors.

-->
## Kibana integration setup

After {{edot-cf}} for AWS is successfully running and forwarding logs to Elastic Observability, install the {{kib}} integrations to visualize your data with out-of-the-box dashboards and visualizations.

To set up data visualization in {{kib}}:

1.Log into your Elastic Cloud deployment and open Kibana.
2. Go to **Management** → **Integrations** in the Kibana navigation menu.
3. Search for the appropriate integration based on your log type and install it:

| **AWS Log Type** | **Integration Name** | **Description** |
|------------------|---------------------|-----------------|
| ELB Access Logs | **AWS ELB OpenTelemetry Assets** | Dashboards and visualizations for Elastic Load Balancer logs |
| VPC Flow Logs | **AWS VPC Flow Logs OpenTelemetry Assets** | Dashboards and visualizations for VPC flow log data |
| CloudTrail Logs | **AWS CloudTrail Logs OpenTelemetry Assets** | Dashboards and visualizations for CloudTrail log data |

4. Once installed, navigate to **Dashboard** to view the pre-built dashboards for your AWS log data.

## Error handling and retrying

{{edot-cf}} store Lambda invocation events related to retryable errors at the S3 bucket specified by `S3FailureBucketARN` parameter.
Retryable errors here include, 
 - Network errors when attempting to forward to OTLPEndpoint
 - Invalid or expired ElasticApiKey
 - Lambda triggered by events that mismatch EdotCloudForwarderS3LogsType selection 

These errors can be replayed manually to back-fill any gaps in your data.

### Replay failed events

To replay errors invoke the Lambda with manual trigger type `replayFailedEvents`. Replace `<LAMBDA_NAME>` with the name from your deployment.

```sh
aws lambda invoke \
  --function-name <LAMBDA_NAME> \
  --payload '{ "replayFailedEvents": {"replayFailedEvents":{"dryrun":false,"removeOnSuccess":true}}}' \
  --cli-binary-format raw-in-base64-out /dev/null
```

The following settings are available:

| Option          | Description                                                                                                                                   | Default |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------|---------|
| dryrun          | Run the command without processing actual backup events. Useful to understand details about replaying error files from Lambda CloudWatch logs. | false   |
| removeOnSuccess | Configure whether to remove error event from S3 error destination, if processing is successful.                                                | true    |

When successful, you should get `"StatusCode": 200` as the output. Check CloudWatch logs (resource `LambdaLogGroup`) for detailed logs.

:::{note}
With AWS CLI, you can use `--timeout` to increase currently configured Lambda timeout for custom invocations.
However, if a timeout occurs, you need to run the custom event multiple times to fully process all error events from the bucket.
:::

## Delete a CloudFormation stack

If you no longer need a deployed stack and want to clean up all associated resources, you can delete it using either the AWS CLI or the AWS Console.

### Important considerations

Deleting a stack will remove all AWS resources created by that stack. However:

- If you allowed the stack to automatically create a dedicated S3 bucket for failed Lambda invocations, that bucket will **not** be deleted if it contains objects, because CloudFormation doesn't force-delete non-empty buckets. To remove the bucket entirely, you must empty it manually before deleting it.
- If you specified an existing bucket through the `S3FailureBucketARN` parameter, that bucket will **not** be deleted because it is not managed by the stack.

### Delete using AWS CLI

Use the following command to delete a stack:

```sh
aws cloudformation delete-stack \
  --stack-name <stack-name> \
  --region <stack-region>
```

You can monitor the deletion progress through this command:

```sh
aws cloudformation describe-stacks \
  --stack-name <stack-name> \
  --region <stack-region>
```

If the stack deletion fails and remains in a `DELETE_FAILED` state, you can retry the deletion with force mode:

```sh
aws cloudformation delete-stack \
  --stack-name <stack-name> \
  --region <stack-region> \
  --deletion-mode FORCE_DELETE_STACK
```

This forcibly deletes the stack's resources, except any that cannot be deleted, like the failure S3 bucket if it still contains objects. For a complete cleanup, empty the bucket manually before retrying deletion.

:::{dropdown} Example: Deleting a stack via AWS CLI

The following command deletes the `edot-cloud-forwarder-vpc` stack:

```sh
aws cloudformation delete-stack \
  --stack-name edot-cloud-forwarder-vpc \
  --region eu-central-1
```

Monitor the deletion progress:

```sh
aws cloudformation describe-stacks \
  --stack-name edot-cloud-forwarder-vpc \
  --region eu-central-1
```

:::

### Delete using AWS Console

To delete a stack through the AWS Management Console:

1. Navigate to **CloudFormation** in the AWS Management Console.
2. Select the stack you want to delete from the list.
3. Click **Delete** at the top of the stack details page.
4. Monitor the deletion progress on the **Events** tab or wait until the stack disappears from the stack list (indicating deletion is complete).

## Monitoring and Troubleshooting

### Monitor Lambda performance

To monitor your {{edot-cf}} Lambda function performance and troubleshoot issues:

1. **CloudWatch Metrics Explorer**: View Lambda metrics such as:
   - Duration
   - ConcurrentExecutions
   - Errors
   - Throttles
   - Invocations

2. **CloudWatch Logs**: Check the Lambda function logs for:
   - Processing errors
   - Configuration issues
   - Data export failures

The `LambdaLogGroup` resource created by the CloudFormation stack stores all Lambda execution logs. Look for error messages or warnings that indicate configuration or performance issues.
