---
navigation_title: AWS
description: Set up the EDOT Cloud Forwarder for AWS to bring your AWS logs to Elastic Observability.
applies_to:
  serverless:
    observability: preview
products:
  - id: cloud-serverless
  - id: observability
  #- id: edot-cf
---

# EDOT Cloud Forwarder for AWS

{{edot-cf}} for AWS provides the EDOT Collector as a Lambda function that collects and forwards logs to Elastic Observability on {{serverless-full}}. {{edot-cf}} for AWS supports the following log sources:

| Log source | Description |
| --- | --- |
| VPC Flow | Logs generated by a VPC (Virtual Private Cloud). |
| ELB Access | Logs generated by an ELB (Elastic Load Balancer). |
| CloudWatch | Logs generated by AWS CloudWatch. |

Read on to learn how to set up {{edot-cf}} for AWS.

::::{important}
{{edot-cf}} for AWS is not supported on {{ech}} or self-managed {{stack}}.
::::

## Prerequisites

To collect logs using {{edot-cf}} for AWS you need:

::::{tab-set}

:::{tab-item} VPC Flow

To collect VPC Flow logs, you need:

- A VPC (Virtual Private Cloud).
- An S3 bucket for storing flow logs.
- A flow log configured with the S3 bucket as the destination.

:::

:::{tab-item} ELB Access

To collect ELB (Elastic Load Balancer) Access logs, you need:

- An ELB of any type (ALB, NLB, CLB).
- An S3 bucket to store the access logs.
- Access logging enabled, with the bucket as the destination.

:::

:::{tab-item} CloudWatch

To collect CloudWatch logs, you need:

- A CloudWatch Log Group where logs are stored.

:::
::::

In addition, you need to know the URL of the managed OTLP endpoint and the API key for authentication.

:::{include} ../_snippets/serverless-endpoint-api.md
:::

## Deployment considerations

Before deploying {{edot-cf}} for AWS, keep these points in mind:

- Deploy a separate CloudFormation stack for each log type, for example VPC Flow Logs, ELB Logs, or CloudWatch Logs. Each CloudFormation stack can only process one log source and format at a time.
- Logs stored in S3 must be placed in separate buckets. Each log type should reside in its own dedicated bucket.

## Download the template

Download the CloudFormation template to deploy the appropriate stack based on your log source:

| Log Source | CloudFormation template |
| --- | --- |
| S3 logs | `s3_logs-cloudformation.yaml` |
| CloudWatch logs | `cloudwatch_logs-cloudformation.yaml` |

## Configure the template

{{edot-cf}} for AWS uses a CloudFormation template to deploy the EDOT Collector as a Lambda function.

### Required settings

These are the required settings you need to set in the CloudFormation templates:

| Setting            | Description |
| ------------------------- | --- |
| `region`            | AWS region where the CloudFormation stack is to be deployed. |
| `stack-name`        | Name of the CloudFormation stack. For example, `vpc-edot-cf`. Do not use the same name for different sources. |
| `OTLPEndpoint`      | The OTLP endpoint URL used for data ingestion. |
| `ElasticApiKey`     | API key for authentication with Elastic. |

### Log source settings

Set the following settings based on the log source:

::::{tab-set}

:::{tab-item} S3

In the `s3_logs-cloudformation.yaml` template, set the following settings:

| Setting            | Description |
| ------------------- | --- |
| `SourceS3BucketARN` | Amazon Resource Name (ARN) of the S3 bucket where logs are stored. This bucket will trigger the `edot-cloud-forwarder` Lambda function automatically. |
| `EdotCloudForwarderS3LogsType` | The encoding format for logs in the S3 bucket. Supported options:<br>• `vpc_flow_log` – VPC Flow Logs<br>• `elb_access_log` – Elastic Load Balancer (ELB) Access Logs<br>• `s3_access_log` – S3 Access Logs<br>• `json` – JSON-formatted logs |
| `S3LogsJsonEncodingMode` | *(Required if `EdotCloudForwarderS3LogsType` is `json`)*<br>Defines how JSON logs are structured:<br>• `body` *(default)* – Stores logs in the request body<br>• `body_with_inline_attributes` – Logs include inline attributes |

:::

:::{tab-item} CloudWatch

In the `cloudwatch_logs-cloudformation.yaml` template, set the following settings:

| Setting            | Description |
| ------------------- | --- |
| `SourceCloudWatchLogGroupARN` | Amazon Resource Name (ARN) of the CloudWatch Log Group where the subscription filter will be created. This Log Group serves as the primary storage location for logs. |

:::
::::

### Optional settings

These are optional settings you can set in the CloudFormation template:

| Setting            | Description |
| ------------------- | --- |
| `EdotCloudForwarderVersion` | Version of the EDOT Cloud Forwarder. Expected format is is `0-1-2`, with hyphens replacing periods. Defaults to the latest available patch version. Don't change this value unless advised by Elastic Support. |
| `EdotCloudForwarderTimeout` | Maximum execution time for the Lambda function, measured in seconds. Default value is `300` seconds. Maximum value is `900` seconds. Minimum value is `1` second. |
| `EdotCloudForwarderMemorySize` | Set the allocated memory for the Lambda function, measured in megabytes. Default value is `1024` MB. Maximum value is `10240` MB. Minimum value is `128` MB. | 
| `EdotCloudForwarderConcurrentExecutions` | Set the maximum number of reserved concurrent executions for the Lambda function. Default value is `50`. Make sure this value doesn't exceed your AWS account's concurrency limit. |

## Deployment examples

The following examples use the default CloudFormation templates.

::::{tab-set}

:::{tab-item} VPC Flow logs

This example deploys a CloudFormation stack to collect VPC Flow Logs stored in an S3 bucket.

```sh
aws cloudformation deploy \
  --template-file templates/s3_logs-cloudformation.yaml \
  --stack-name edot-cloud-forwarder-vpc \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameter-overrides \
    SourceS3BucketARN=your-s3-vpc-bucket-arn \
    OTLPEndpoint="<placeholder>" \
    ElasticAPIKey="<placeholder>" \
    EdotCloudForwarderS3LogsType="vpc_flow_log"
```
:::

:::{tab-item} ELB Access logs

This example deploys a CloudFormation stack to collect ALB Access Logs stored in an S3 bucket.

```sh
aws cloudformation deploy \
  --template-file templates/s3_logs-cloudformation.yaml \
  --stack-name edot-cloud-forwarder-alb \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameter-overrides \
    SourceS3BucketARN=your-s3-alb-bucket-arn \
    OTLPEndpoint="<placeholder>" \
    ElasticAPIKey="<placeholder>" \
    EdotCloudForwarderS3LogsType="elb_access_log"
```
:::

:::{tab-item} CloudWatch logs

This example deploys a CloudFormation stack to collect CloudWatch logs sent to a Log Group.

```sh
aws cloudformation deploy \
  --template-file templates/cloudwatch_logs-cloudformation.yaml \
  --stack-name edot-cloud-forwarder-cw \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameter-overrides \
    OTLPEndpoint="<placeholder>" \
    ElasticAPIKey="<placeholder>" \
    SourceCloudWatchLogGroup="your-log-group"
```
:::
::::

## Update a CloudFormation stack

To update an existing CloudFormation stack while preserving unchanged parameters, follow these steps:

::::::{stepper}

:::::{step} Identify the stack to update

Determine the name of the CloudFormation stack you want to modify.

:::::

:::::{step} Prepare the update command

Use the following structure for your update command:

- Include all required parameters.
- Use `UsePreviousValue=true` for parameters that should remain unchanged.
- Specify `ParameterValue=<new-value>` for parameters that need to be updated.

:::::

:::::{step} Run the update-stack command

Run the command with the following parameters:

```sh
aws cloudformation update-stack \
  --template-body file://<path-to-cloudformation-template-file> \
  --stack-name <stack-name> \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameters \
      ParameterKey=Param1,UsePreviousValue=true \
      ParameterKey=Param2,UsePreviousValue=true \
      ParameterKey=Param3,UsePreviousValue=true \
      ParameterKey=Param4,ParameterValue=<new-value>
```

For example, to modify the S3 bucket ARN for the `edot-cloud-forwarder-vpc` stack while keeping other parameters unchanged:

```sh
aws cloudformation update-stack \
  --template-body file://templates/s3_logs-cloudformation.yaml \
  --stack-name edot-cloud-forwarder-vpc \
  --capabilities CAPABILITY_NAMED_IAM \
  --region eu-central-1 \
  --parameters \
      ParameterKey=OTLPEndpoint,UsePreviousValue=true \
      ParameterKey=ElasticAPIKey,UsePreviousValue=true \
      ParameterKey=EdotCloudForwarderS3LogsType,UsePreviousValue=true \
      ParameterKey=SourceS3BucketARN,ParameterValue=your-new-s3-vpc-bucket-arn
```
:::::

:::::{step} Verify the update

After running the command, check the stack status in the AWS Management Console under **CloudFormation** → **Stacks**. Then, run this command to confirm the updated parameter values:

```sh
aws cloudformation describe-stacks --stack-name <stack-name>
```
:::::
::::::

## Manual deployment using the CloudFormation Console

You can deploy the stack manually using the AWS Management Console by following these steps:

1. Navigate to CloudFormation in the AWS Console.  
2. Select **Create Stack** and choose one of the following options:  
   - **Amazon S3 URL** to use a pre-hosted CloudFormation template.  
   - **Upload a template file** to select the appropriate CloudFormation template based on your log source.  
3. Select **Next** and configure all required parameters.  
4. Select **Next** again and check the **"Acknowledge IAM capabilities"** box.  
5. Review your settings and select **Submit** to deploy the stack.  
6. Monitor the stack creation process until it reaches the `CREATE_COMPLETE` state.  

## CloudFormation stack resources

The CloudFormation templates create a number of resources to process logs from a specific log source.

### Resources for S3 logs

This is a list of resources created by the stack when processing S3 logs.

| Resource name               | Type                             | Description |
|---------------------------|--------------------------------------|----------------|
| `CustomNotificationUpdater` | `AWS::CloudFormation::CustomResource` | Custom resource used to manage S3 event notifications dynamically. |
| `LambdaExecutionRole`       | `AWS::IAM::Role`                   | IAM role granting permissions needed for the Lambda function to interact with S3 and other AWS services. |
| `LambdaFunction`            | `AWS::Lambda::Function`            | Core Lambda function responsible for processing incoming logs from S3. This is a key resource in the stack. |
| `LambdaInvokeConfig`        | `AWS::Lambda::EventInvokeConfig`   | Configures error handling and invocation settings for the Lambda function. |
| `LambdaLogGroup`            | `AWS::Logs::LogGroup`               | CloudWatch log group storing logs for the main Lambda function. Useful for debugging and monitoring. |
| `LambdaPermissionS3Bucket`  | `AWS::Lambda::Permission`          | Grants permission for S3 to invoke the Lambda function when new logs arrive. |
| `LambdaS3TriggerPolicy`     | `AWS::IAM::Policy`                 | IAM policy allowing the Lambda function to process events triggered by S3. |
| `NotificationUpdaterLambda` | `AWS::Lambda::Function`            | Utility Lambda function handling S3 event notification updates dynamically. |
| `NotificationUpdaterLambdaLogGroup` | `AWS::Logs::LogGroup`         | CloudWatch log group storing logs for the `NotificationUpdaterLambda` function. |
| `S3FailureBucketArn`               | `AWS::S3::Bucket`                   | ARN of the bucket for storing failed invocations from the `edot-cloud-forwarder` Lambda function, preventing data loss, in the format `arn:aws:s3:::your-bucket-name`. If not defined, the template creates a dedicated failure bucket automatically. |

The main Lambda function, `LambdaFunction`, is the core component for processing S3 logs. S3 event notifications are handled dynamically using `CustomNotificationUpdater` and `NotificationUpdaterLambda`. 

CloudWatch logs ensure detailed monitoring of Lambda executions. IAM roles and permissions control access between S3 and Lambda functions, while `S3FailureBucket` prevents data loss by capturing unprocessed logs.

### Resources for CloudWatch Logs

This is a list of resources created by the stack when CloudWatch logs are the source.

| Resource name                  | Type                             | Description |
|------------------------------------|--------------------------------------|----------------|
| `CloudWatchLogSubscriptionFilter` | `AWS::Logs::SubscriptionFilter` | Defines a filter that forwards logs from a CloudWatch Log Group to the Lambda function. Critical for log processing. |
| `LambdaExecutionRole`              | `AWS::IAM::Role`                   | IAM role granting necessary permissions for the Lambda function to interact with CloudWatch Logs and other AWS services. |
| `LambdaFunction`                   | `AWS::Lambda::Function`            | Core Lambda function responsible for processing incoming logs from CloudWatch. This is a key resource in the stack. |
| `LambdaInvokeConfig`               | `AWS::Lambda::EventInvokeConfig`   | Configures event invocation settings, including error handling and retry behavior. |
| `LambdaLogGroup`                   | `AWS::Logs::LogGroup`               | CloudWatch log group that stores execution logs for the main Lambda function, aiding monitoring and debugging. |
| `LambdaPermissionCloudWatch`       | `AWS::Lambda::Permission`          | Grants permission for CloudWatch Logs to invoke the Lambda function, enabling real-time log streaming. |
| `S3FailureBucket`                  | `AWS::S3::Bucket`                   | Dedicated S3 bucket for storing failed log events to prevent data loss. An important safeguard resource. |

The CloudWatch Log Subscription Filter, `CloudWatchLogSubscriptionFilter`, ensures logs are correctly forwarded to the Lambda function. The Lambda function, `LambdaFunction`, serves as the core processing unit for CloudWatch logs. 

CloudWatch Log Groups help monitor execution performance and debug issues. IAM permissions (`LambdaExecutionRole`, `LambdaPermissionCloudWatch`) control interactions between CloudWatch and Lambda, while the failure bucket, `S3FailureBucket`, helps prevent data loss in case of processing errors.